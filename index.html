<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®½æ•å°±æ˜¯çˆ± - AIæ™ºèƒ½é˜…è¯»åŠ©æ‰‹</title>
    <meta name="description" content="åŸºäºAIçš„æ™ºèƒ½é˜…è¯»åŠ©æ‰‹ï¼Œå¸®åŠ©ç”¨æˆ·æ·±åº¦ç†è§£ã€Šå®½æ•å°±æ˜¯çˆ±ã€‹ï¼Œç”Ÿæˆä¸ªæ€§åŒ–æ„Ÿæ‚Ÿå’ŒçŸ­è§†é¢‘æ–‡æ¡ˆ">
    <meta name="keywords" content="AIé˜…è¯»åŠ©æ‰‹,å®½æ•å°±æ˜¯çˆ±,æ™ºèƒ½åˆ†æ,å¿ƒçµæˆé•¿,ä¸ªäººå‘å±•">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Microsoft YaHei", "PingFang SC", "Hiragino Sans GB", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .section {
            margin: 30px 0;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 15px;
            border-left: 5px solid #4facfe;
        }

        .section h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #ff6b6b 0%, #ffa500 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%);
        }

        .upload-area {
            border: 2px dashed #4facfe;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: white;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #00f2fe;
            background: #f0f8ff;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .stat-number {
            font-size: 2.2rem;
            font-weight: bold;
            color: #4facfe;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 1rem;
        }

        .chapter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .chapter-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .chapter-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border-color: #4facfe;
        }

        .chapter-card.current {
            border-color: #ff6b6b;
            background: linear-gradient(135deg, #fff5f5 0%, #ffe0e0 100%);
        }

        .chapter-card.completed {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .reading-area {
            background: white;
            padding: 30px;
            border-radius: 15px;
            line-height: 1.8;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .ai-result {
            background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
            padding: 25px;
            border-radius: 15px;
            margin-top: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .ai-section {
            margin-bottom: 25px;
        }

        .ai-section h4 {
            color: #d63031;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .video-script {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #4facfe;
        }

        .hidden {
            display: none;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .input-group input, .input-group select, .input-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus, .input-group select:focus, .input-group textarea:focus {
            outline: none;
            border-color: #4facfe;
        }

        .progress-bar {
            width: 100%;
            height: 25px;
            background: #e0e0e0;
            border-radius: 12px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe, #00f2fe);
            transition: width 0.8s ease;
            width: 0%;
        }

        .api-status {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            display: none;
            font-weight: 500;
        }

        .api-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .api-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .api-loading {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #b8daff;
        }

        .footer {
            background: #333;
            color: white;
            padding: 30px;
            text-align: center;
            margin-top: 40px;
        }

        .footer p {
            margin: 5px 0;
        }

        .footer a {
            color: #4facfe;
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .main-content {
                padding: 20px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .chapter-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>å®½æ•å°±æ˜¯çˆ±</h1>
            <p>AIæ™ºèƒ½é˜…è¯»åŠ©æ‰‹ Â· æ·±åº¦æ„Ÿæ‚Ÿç”Ÿæˆå™¨</p>
        </div>

        <div class="main-content">
            <!-- APIé…ç½®åŒºåŸŸ -->
            <div class="section" id="apiSetup">
                <h3>ğŸ”§ AIé…ç½®</h3>
                <p>é…ç½®AIæ¥å£ä»¥è·å¾—ä¸ªæ€§åŒ–æ·±åº¦åˆ†æï¼ˆæ¨èï¼šæ™ºè°±GLM-4ï¼Œæˆæœ¬ä½æ•ˆæœå¥½ï¼‰</p>
                
                <div class="api-status" id="apiStatus"></div>
                
                <div class="input-group">
                    <label>APIå¯†é’¥ (API Key):</label>
                    <input type="password" id="apiKey" placeholder="è¯·è¾“å…¥æ‚¨çš„AI APIå¯†é’¥">
                    <small style="color: #666; font-size: 0.9em;">è·å–æ–¹å¼ï¼šæ³¨å†Œæ™ºè°±AIå¼€æ”¾å¹³å° (open.bigmodel.cn)</small>
                </div>
                
                <div class="input-group">
                    <label>APIç±»å‹:</label>
                    <select id="apiType">
                        <option value="zhipu">æ™ºè°±GLM-4 (æ¨è)</option>
                        <option value="qianwen">é€šä¹‰åƒé—®</option>
                        <option value="openai">OpenAI GPT</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label>APIç«¯ç‚¹ (å¯é€‰):</label>
                    <input type="text" id="apiBaseUrl" placeholder="è‡ªå®šä¹‰APIç«¯ç‚¹ï¼Œç•™ç©ºä½¿ç”¨é»˜è®¤">
                </div>
                
                <button class="btn" onclick="saveConfig()">ä¿å­˜é…ç½®</button>
                <button class="btn btn-secondary" onclick="testAPI()" id="testBtn">æµ‹è¯•è¿æ¥</button>
            </div>

            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <div class="stats hidden" id="statsArea">
                <div class="stat-card">
                    <div class="stat-number" id="totalChapters">0</div>
                    <div class="stat-label">æ€»ç« èŠ‚æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completedChapters">0</div>
                    <div class="stat-label">å·²å®Œæˆç« èŠ‚</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="progressPercent">0%</div>
                    <div class="stat-label">é˜…è¯»è¿›åº¦</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="streakDays">0</div>
                    <div class="stat-label">è¿ç»­å¤©æ•°</div>
                </div>
            </div>

            <div class="progress-bar hidden" id="overallProgress">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <!-- ä¹¦ç±å¯¼å…¥åŒºåŸŸ -->
            <div class="section" id="uploadSection">
                <h3>ğŸ“š å¯¼å…¥ä¹¦ç±</h3>
                <div class="upload-area" onclick="selectFile()">
                    <h3>ğŸ“– ç‚¹å‡»ä¸Šä¼ TXTæ ¼å¼ä¹¦ç±</h3>
                    <p>æ”¯æŒã€Šå®½æ•å°±æ˜¯çˆ±ã€‹ç­‰å¿ƒçµæˆé•¿ç±»ä¹¦ç±</p>
                    <p style="color: #666; font-size: 0.9em;">æˆ–ç›´æ¥ä½¿ç”¨ä¸‹æ–¹çš„ç¤ºä¾‹ä¹¦ç±å¼€å§‹ä½“éªŒ</p>
                </div>
                <input type="file" id="fileInput" accept=".txt" style="display:none" onchange="handleFile(event)">
                <button class="btn btn-success" onclick="loadSampleBook()">ä½¿ç”¨ã€Šå®½æ•å°±æ˜¯çˆ±ã€‹ç¤ºä¾‹</button>
                
                <div class="hidden" id="exportSection" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd;">
                    <h4>ğŸ“¤ å¯¼å‡ºåŠŸèƒ½</h4>
                    <button class="btn" onclick="exportProgress()">å¯¼å‡ºé˜…è¯»è¿›åº¦</button>
                    <button class="btn" onclick="exportInsights()">å¯¼å‡ºæ‰€æœ‰æ„Ÿæ‚Ÿ</button>
                </div>
            </div>

            <!-- ç« èŠ‚åˆ—è¡¨ -->
            <div class="section hidden" id="chaptersSection">
                <h3>ğŸ“– ç« èŠ‚ç®¡ç†</h3>
                <div style="margin-bottom: 20px;">
                    <button class="btn" onclick="markAllRead()">å…¨éƒ¨æ ‡è®°ä¸ºå·²è¯»</button>
                    <button class="btn btn-secondary" onclick="resetProgress()">é‡ç½®è¿›åº¦</button>
                    <button class="btn" onclick="autoReadMode()" id="autoBtn">è‡ªåŠ¨é˜…è¯»æ¨¡å¼</button>
                </div>
                <div class="chapter-grid" id="chapterGrid"></div>
            </div>

            <!-- é˜…è¯»åŒºåŸŸ -->
            <div class="section hidden" id="readingSection">
                <h3>âœ¨ ä»Šæ—¥é˜…è¯»</h3>
                <div class="reading-area" id="readingContent"></div>
                
                <div style="margin: 20px 0;">
                    <button class="btn" id="generateBtn" onclick="generateInsight()" disabled>
                        <span id="btnText">ç”ŸæˆAIæ·±åº¦æ„Ÿæ‚Ÿ</span>
                    </button>
                    <button class="btn" onclick="toggleNote()">ğŸ“ æ·»åŠ ä¸ªäººç¬”è®°</button>
                    <button class="btn btn-success" onclick="shareInsight()">ğŸ“± åˆ†äº«æ„Ÿæ‚Ÿ</button>
                </div>
                
                <textarea id="personalNote" placeholder="åœ¨è¿™é‡Œå†™ä¸‹æ‚¨å¯¹æœ¬ç« çš„ä¸ªäººæ„Ÿæ‚Ÿå’Œæ€è€ƒ..." 
                    style="width: 100%; height: 100px; margin: 10px 0; display: none;" class="input-group"></textarea>
                
                <div class="ai-result hidden" id="aiResult"></div>
            </div>
        </div>

        <div class="footer">
            <p><strong>å®½æ•å°±æ˜¯çˆ± - AIæ™ºèƒ½é˜…è¯»åŠ©æ‰‹</strong></p>
            <p>åŸºäºå…ˆè¿›AIæŠ€æœ¯ï¼Œæä¾›ä¸ªæ€§åŒ–æ·±åº¦é˜…è¯»åˆ†æ</p>
            <p>é¡¹ç›®å¼€æºåœ°å€: <a href="https://github.com/ä½ çš„ç”¨æˆ·å/forgiveness-reading-assistant" target="_blank">GitHub</a></p>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let bookChapters = [];
        let currentChapter = 0;
        let readingProgress = {};
        let personalNotes = {};
        let apiConfig = {};
        let autoReadTimer = null;

        // DOMåŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
            loadSavedData();
        });

        // åŠ è½½ä¿å­˜çš„æ•°æ®
        function loadSavedData() {
            try {
                // åŠ è½½APIé…ç½®
                const savedConfig = localStorage.getItem('apiConfig');
                if (savedConfig) {
                    apiConfig = JSON.parse(savedConfig);
                    const apiKeyInput = document.getElementById('apiKey');
                    const apiTypeSelect = document.getElementById('apiType');
                    const apiBaseUrlInput = document.getElementById('apiBaseUrl');
                    
                    if (apiKeyInput) apiKeyInput.value = apiConfig.apiKey || '';
                    if (apiTypeSelect) apiTypeSelect.value = apiConfig.apiType || 'zhipu';
                    if (apiBaseUrlInput) apiBaseUrlInput.value = apiConfig.baseUrl || '';
                }

                // åŠ è½½é˜…è¯»è¿›åº¦
                const savedProgress = localStorage.getItem('readingProgress');
                if (savedProgress) {
                    readingProgress = JSON.parse(savedProgress);
                }

                // åŠ è½½ä¸ªäººç¬”è®°
                const savedNotes = localStorage.getItem('personalNotes');
                if (savedNotes) {
                    personalNotes = JSON.parse(savedNotes);
                }

                // åŠ è½½ä¹¦ç±ç« èŠ‚
                const savedChapters = localStorage.getItem('bookChapters');
                if (savedChapters) {
                    bookChapters = JSON.parse(savedChapters);
                    initializeReading();
                }

                console.log('æ•°æ®åŠ è½½å®Œæˆ');
            } catch (error) {
                console.error('æ•°æ®åŠ è½½é”™è¯¯:', error);
            }
        }

        // APIç›¸å…³åŠŸèƒ½
        function saveConfig() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const apiType = document.getElementById('apiType').value;
            const baseUrl = document.getElementById('apiBaseUrl').value.trim();

            if (!apiKey) {
                showStatus('è¯·è¾“å…¥APIå¯†é’¥', 'error');
                return;
            }

            apiConfig = {
                apiKey: apiKey,
                apiType: apiType,
                baseUrl: baseUrl || getDefaultApiUrl(apiType)
            };

            localStorage.setItem('apiConfig', JSON.stringify(apiConfig));
            showStatus('âœ“ APIé…ç½®ä¿å­˜æˆåŠŸï¼', 'success');

            if (bookChapters.length > 0) {
                document.getElementById('generateBtn').disabled = false;
            }
        }

        function getDefaultApiUrl(type) {
            const urls = {
                'zhipu': 'https://open.bigmodel.cn/api/paas/v4/chat/completions',
                'qianwen': 'https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation',
                'openai': 'https://api.openai.com/v1/chat/completions'
            };
            return urls[type] || urls.zhipu;
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('apiStatus');
            if (!statusDiv) return;

            statusDiv.className = `api-status api-${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';

            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 3000);
            }
        }

        async function testAPI() {
            if (!apiConfig.apiKey) {
                showStatus('è¯·å…ˆä¿å­˜APIé…ç½®', 'error');
                return;
            }

            const testBtn = document.getElementById('testBtn');
            testBtn.disabled = true;
            testBtn.textContent = 'æµ‹è¯•ä¸­...';

            try {
                const result = await callRealAPI('è¿™æ˜¯ä¸€ä¸ªAPIè¿æ¥æµ‹è¯•', true);
                if (result.success) {
                    showStatus('âœ“ APIè¿æ¥æˆåŠŸï¼', 'success');
                } else {
                    showStatus('âœ— APIæµ‹è¯•å¤±è´¥: ' + result.error, 'error');
                }
            } catch (error) {
                showStatus('âœ— è¿æ¥é”™è¯¯: ' + error.message, 'error');
            }

            testBtn.disabled = false;
            testBtn.textContent = 'æµ‹è¯•è¿æ¥';
        }

        // æ–‡ä»¶å¤„ç†
        function selectFile() {
            document.getElementById('fileInput').click();
        }

        function handleFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                parseBookContent(e.target.result);
            };
            reader.readAsText(file, 'UTF-8');
        }

        function loadSampleBook() {
            const sampleChapters = [
                'å®½æ•çš„çœŸè°›ï¼ˆä»£åºï¼‰',
                'æ‰¾å›è‡ªå·±å†…åœ¨çš„çˆ±', 
                'å‰è¨€',
                'ç®€ä»‹ï¼šå®½æ•çš„å››å¤§åŸåˆ™',
                'ç¬¬ä¸€è¦è¯€ï¼šå¯¹è‡ªå·±çš„å¹³å®‰è´Ÿè´£',
                'ç¬¬ä¸€æ‹› æ‰¿è®¤ææƒ§',
                'ç¬¬äºŒæ‹› äº†è§£è‡ªå·±æ¸´æœ›çš„æ˜¯çˆ±',
                'ç¬¬ä¸‰æ‹› æ”¶å›æŠ•å°„',
                'ç¬¬å››æ‹› å¯¹è‡ªå·±è´Ÿè´£',
                'ç¬¬äºŒè¦è¯€ï¼šæ‰¾å›ä½ æˆ‘å¹³ç­‰ä¹‹å¤„',
                'ç¬¬äº”æ‹› æ”¾ä¸‹è‡ªæˆ‘æ‰¹åˆ¤ä¸å†…ç–š',
                'ç¬¬å…­æ‹› æ¥çº³è‡ªå·±ä»¥åŠå¾…äººå¦‚å·±',
                'ç¬¬ä¸ƒæ‹› ä¹æ„å­¦ä¹ ä¸åˆ†äº«',
                'ç¬¬å…«æ‹› åšè‡ªå·±çš„ä¸»äºº',
                'ç¬¬ä¸‰è¦è¯€ï¼šä¿¡ä»»è‡ªå·±çš„ç”Ÿå‘½',
                'ç¬¬ä¹æ‹› æ¥å—äººç”Ÿè¯¾ç¨‹',
                'ç¬¬åæ‹› è®¤å‡ºä¸€åˆ‡éƒ½æ²¡æœ‰é—®é¢˜',
                'ç¬¬åä¸€æ‹› çœ‹é•œä¸­äººç”Ÿ',
                'ç¬¬åäºŒæ‹› å¼€æ”¾å¿ƒçµ',
                'ç¬¬å››è¦è¯€ï¼šé“­è®°"ç”Ÿå‘½æ˜¯çˆ±"'
            ];

            const sampleContents = {
                'å®½æ•çš„çœŸè°›ï¼ˆä»£åºï¼‰': 'å®½æ•ä¸æ˜¯ä¸€ä¸ªè¡ŒåŠ¨è€Œå·²ï¼Œå®ƒæ˜¯ä¸€è¿ä¸²çš„"æ­£å¿µ"æ‰€ç´¯ç§¯å‡ºæ¥çš„"å¿ƒèƒ¸"ï¼Œè¿™ä¸æ˜¯å¬å‡ æ¬¡æ¼”è®²æˆ–è¯»å‡ æœ¬ä¹¦å°±èƒ½è·å¾—çš„ç»éªŒï¼Œå› å®ƒä¸ä¸ªäººçš„æ— çŸ¥ã€ææ…Œã€é€ƒé¿ã€è‡ªè´£ã€å°é—­ã€æŠ—æ‹’ç­‰ç­‰éšè—çš„å¿ƒæ€æœ‰å…³...',
                'æ‰¾å›è‡ªå·±å†…åœ¨çš„çˆ±': 'è¿™æœ¬ä¹¦è™½å°ï¼Œå´èŠ±äº†æˆ‘äºŒå¹´çš„æ—¶é—´ç¿»è¯‘ï¼Œå› ä¸ºåœ¨ç¿»è¯‘çš„è¿‡ç¨‹ä¸­ï¼Œå‘ç”Ÿäº†ä¸€è¿ä¸²ç¦»å¥‡çš„äº‹ä»¶ï¼ŒæŠŠæˆ‘ä»é‡Œåˆ°å¤–å‰¥äº†ä¸¤å±‚çš®ï¼Œè®©æˆ‘ä»¿ä½›è„±èƒæ¢éª¨èˆ¬åœ°å˜æˆäº†å¦ä¸€ä¸ªäºº...',
                'ç¬¬ä¸€æ‹› æ‰¿è®¤ææƒ§': 'ä¸€æ—¦æ‰¿è®¤äº†è‡ªå·±çš„ææƒ§ã€æ‚²ä¼¤ã€ç—›è‹¦ã€åˆ›ä¼¤ã€é€€ç¼©ã€å«‰å¦’ã€æ„¤æ€’ï¼Œå’Œåˆ†è£‚æ„Ÿï¼Œæˆ‘ä»¬ä¾¿å·²è¸ä¸Šè¿™è¶Ÿå®½æ•ä¹‹æ—…äº†ï¼Œæ—¢ä¸å†ä¸ºé‚£äº›æ„Ÿè§‰è¾©æŠ¤ï¼Œä¹Ÿä¸è°´è´£å®ƒä»¬ï¼Œåªæ˜¯å…è®¸è‡ªå·±å¯Ÿè§‰åˆ°å®ƒä»¬çš„å­˜åœ¨...'
            };

            bookChapters = sampleChapters.map((title, index) => ({
                title: title,
                content: sampleContents[title] || `è¿™æ˜¯ç¬¬${index + 1}ç« "${title}"çš„å†…å®¹ã€‚æœ¬ç« æ·±å…¥æ¢è®¨äº†å®½æ•ä¸çˆ±çš„æ™ºæ…§ï¼Œå¸®åŠ©æˆ‘ä»¬ç†è§£å¦‚ä½•åœ¨æ—¥å¸¸ç”Ÿæ´»ä¸­å®è·µå®½æ•çš„åŠ›é‡ã€‚é€šè¿‡å­¦ä¹ è¿™äº›æ¦‚å¿µï¼Œæˆ‘ä»¬å¯ä»¥æ›´å¥½åœ°è®¤è¯†è‡ªå·±ï¼Œå­¦ä¼šæ”¾ä¸‹è¿‡å»çš„ä¼¤ç—›ï¼Œæ‹¥æŠ±å½“ä¸‹çš„ç¾å¥½ï¼Œå¹¶å»ºç«‹æ›´å’Œè°çš„äººé™…å…³ç³»ã€‚å®½æ•æ˜¯ä¸€ç§å†…åœ¨çš„è½¬å˜ï¼Œå®ƒä¸ä»…èƒ½å¤Ÿæ²»æ„ˆæˆ‘ä»¬è‡ªå·±ï¼Œä¹Ÿèƒ½å¤Ÿå½±å“å‘¨å›´çš„äººï¼Œåˆ›é€ æ›´å¤šçš„çˆ±ä¸å’Œè°ã€‚`
            }));

            localStorage.setItem('bookChapters', JSON.stringify(bookChapters));
            initializeReading();
        }

        function parseBookContent(content) {
            const lines = content.split('\n').filter(line => line.trim());
            bookChapters = [];

            lines.forEach((line, index) => {
                const trimmed = line.trim();
                if (trimmed && trimmed.length > 2 && !trimmed.includes('/')) {
                    bookChapters.push({
                        title: trimmed,
                        content: `è¿™æ˜¯"${trimmed}"çš„å†…å®¹ã€‚æœ¬ç« èŠ‚åŒ…å«äº†å…³äºå®½æ•ä¸çˆ±çš„æ·±åˆ»æ´å¯Ÿ...`
                    });
                }
            });

            if (bookChapters.length > 0) {
                localStorage.setItem('bookChapters', JSON.stringify(bookChapters));
                initializeReading();
            }
        }

        // ç•Œé¢åˆå§‹åŒ–
        function initializeReading() {
            document.getElementById('uploadSection').classList.add('hidden');
            document.getElementById('chaptersSection').classList.remove('hidden');
            document.getElementById('readingSection').classList.remove('hidden');
            document.getElementById('statsArea').classList.remove('hidden');
            document.getElementById('overallProgress').classList.remove('hidden');
            document.getElementById('exportSection').classList.remove('hidden');

            updateStats();
            renderChapters();
            loadChapter(0);
        }

        function updateStats() {
            const completed = Object.keys(readingProgress).length;
            const progress = bookChapters.length > 0 ? Math.round((completed / bookChapters.length) * 100) : 0;

            document.getElementById('totalChapters').textContent = bookChapters.length;
            document.getElementById('completedChapters').textContent = completed;
            document.getElementById('progressPercent').textContent = progress + '%';
            document.getElementById('streakDays').textContent = calculateStreak();

            const progressFill = document.getElementById('progressFill');
            if (progressFill) {
                progressFill.style.width = progress + '%';
            }
        }

        function calculateStreak() {
            const dates = Object.values(readingProgress)
                .map(p => new Date(p.date).toDateString())
                .sort().reverse();

            let streak = 0;
            let currentDate = new Date();

            for (let dateStr of dates) {
                if (dateStr === currentDate.toDateString()) {
                    streak++;
                    currentDate.setDate(currentDate.getDate() - 1);
                } else {
                    break;
                }
            }

            return streak;
        }

        function renderChapters() {
            const grid = document.getElementById('chapterGrid');
            grid.innerHTML = '';

            bookChapters.forEach((chapter, index) => {
                const card = document.createElement('div');
                card.className = 'chapter-card';

                if (readingProgress[index]) card.classList.add('completed');
                if (index === currentChapter) card.classList.add('current');

                const hasNote = personalNotes[index] && personalNotes[index].trim();
                const completedDate = readingProgress[index] ? 
                    new Date(readingProgress[index].date).toLocaleDateString() : '';

                card.innerHTML = `
                    <h4>ç¬¬${index + 1}ç«  ${hasNote ? 'ğŸ“' : ''}</h4>
                    <p style="margin: 8px 0; font-weight: 500;">${chapter.title}</p>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                        <small style="color: #666;">
                            ${completedDate ? `å®Œæˆäº: ${completedDate}` : 'æœªå¼€å§‹'}
                        </small>
                        <span style="font-size: 1.2em;">
                            ${readingProgress[index] ? 'âœ…' : (index === currentChapter ? 'ğŸ“–' : 'â³')}
                        </span>
                    </div>
                `;

                card.onclick = () => loadChapter(index);
                grid.appendChild(card);
            });
        }

        function loadChapter(index) {
            currentChapter = index;
            const chapter = bookChapters[index];
            const progress = readingProgress[index];
            const note = personalNotes[index];

            let statusBadge = '';
            if (progress) {
                statusBadge = '<span style="background: #4CAF50; color: white; padding: 6px 12px; border-radius: 15px; font-size: 0.9em;">âœ“ å·²å®Œæˆ</span>';
            } else {
                statusBadge = '<span style="background: #2196F3; color: white; padding: 6px 12px; border-radius: 15px; font-size: 0.9em;">ğŸ“– å½“å‰é˜…è¯»</span>';
            }

            document.getElementById('readingContent').innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap;">
                    <h3 style="margin: 0; flex: 1;">${chapter.title}</h3>
                    ${statusBadge}
                </div>
                
                <div style="background: #f8f9fa; padding: 25px; border-radius: 10px; line-height: 1.8; text-align: justify;">
                    ${chapter.content}
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; flex-wrap: wrap;">
                    <p style="color: #666; margin: 0;">
                        ç¬¬ ${index + 1} ç«  / å…± ${bookChapters.length} ç« 
                    </p>
                    <div>
                        ${index > 0 ? `<button class="btn" onclick="loadChapter(${index - 1})" style="padding: 8px 15px; font-size: 0.9em;">â† ä¸Šä¸€ç« </button>` : ''}
                        ${index < bookChapters.length - 1 ? `<button class="btn" onclick="loadChapter(${index + 1})" style="padding: 8px 15px; font-size: 0.9em;">ä¸‹ä¸€ç«  â†’</button>` : ''}
                    </div>
                </div>
                
                ${note ? `<div style="background: #e3f2fd; padding: 15px; border-radius: 10px; margin-top: 15px; border-left: 4px solid #2196F3;">
                    <strong>ğŸ“ æˆ‘çš„ç¬”è®°ï¼š</strong><br>
                    <p style="margin: 8px 0 0 0; line-height: 1.6;">${note}</p>
                </div>` : ''}
            `;

            renderChapters();

            if (apiConfig.apiKey) {
                document.getElementById('generateBtn').disabled = false;
            }

            // æ˜¾ç¤ºå·²æœ‰çš„AIåˆ†æ
            if (progress && progress.insight) {
                displayAIResult(progress.insight, chapter.title);
            } else {
                document.getElementById('aiResult').classList.add('hidden');
            }
        }

        // AIåˆ†æåŠŸèƒ½
        async function generateInsight() {
            if (!apiConfig.apiKey) {
                showStatus('è¯·å…ˆé…ç½®APIå¯†é’¥', 'error');
                return;
            }

            const generateBtn = document.getElementById('generateBtn');
            const btnText = document.getElementById('btnText');
            
            generateBtn.disabled = true;
            btnText.innerHTML = 'ğŸ¤– AIåˆ†æä¸­...';

            try {
                const chapter = bookChapters[currentChapter];
                const prompt = `è¯·æ·±åº¦åˆ†æã€Šå®½æ•å°±æ˜¯çˆ±ã€‹è¿™æœ¬ä¹¦ä¸­"${chapter.title}"è¿™ä¸€ç« èŠ‚çš„å†…å®¹ï¼Œå¹¶æä¾›ï¼š

1. æ ¸å¿ƒè§‚ç‚¹ï¼ˆ3ä¸ªè¦ç‚¹ï¼‰
2. ä¸ªäººæˆé•¿å¯å‘ï¼ˆ2-3å¥æ·±åˆ»çš„è¯ï¼‰
3. ç”Ÿæ´»å®é™…åº”ç”¨ï¼ˆå…·ä½“çš„å®è·µæ–¹æ³•ï¼‰
4. çŸ­è§†é¢‘æ–‡æ¡ˆï¼ˆ3ä¸ªç‰ˆæœ¬ï¼‰ï¼š
   - é‡‘å¥ç‰ˆï¼ˆé€‚åˆé™æ€å›¾æ–‡ï¼‰
   - æ•…äº‹ç‰ˆï¼ˆé€‚åˆå™äº‹è§†é¢‘ï¼‰
   - äº’åŠ¨ç‰ˆï¼ˆé€‚åˆä¸è§‚ä¼—äº’åŠ¨ï¼‰
5. ç›¸å…³è¯é¢˜æ ‡ç­¾å»ºè®®

ç« èŠ‚å†…å®¹ï¼š${chapter.content}

è¯·æä¾›æ·±å…¥ä¸”å®ç”¨çš„åˆ†æï¼Œå¸®åŠ©è¯»è€…çœŸæ­£ç†è§£å’Œåº”ç”¨å®½æ•çš„æ™ºæ…§ã€‚`;

                const result = await callRealAPI(prompt);
                
                if (result.success) {
                    const insight = {
                        content: result.content,
                        timestamp: new Date().toISOString()
                    };
                    
                    displayAIResult(insight, chapter.title);
                    
                    // ä¿å­˜åˆ†æç»“æœ
                    readingProgress[currentChapter] = {
                        date: new Date().toISOString(),
                        insight: insight
                    };
                    
                    localStorage.setItem('readingProgress', JSON.stringify(readingProgress));
                    updateStats();
                    renderChapters();
                    
                    showStatus('âœ“ AIåˆ†æå®Œæˆï¼', 'success');
                } else {
                    showStatus('AIåˆ†æå¤±è´¥: ' + result.error, 'error');
                    generateMockInsight(); // é™çº§åˆ°æ¨¡æ‹Ÿåˆ†æ
                }
            } catch (error) {
                console.error('AIåˆ†æé”™è¯¯:', error);
                showStatus('åˆ†æè¿‡ç¨‹å‡ºé”™ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ', 'error');
                generateMockInsight();
            }

            generateBtn.disabled = false;
            btnText.textContent = 'é‡æ–°ç”Ÿæˆåˆ†æ';
        }

        async function callRealAPI(prompt, isTest = false) {
            const { apiKey, apiType, baseUrl } = apiConfig;

            try {
                let requestBody, headers;

                switch (apiType) {
                    case 'zhipu':
                        headers = {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json'
                        };
                        requestBody = {
                            model: 'glm-4',
                            messages: [{
                                role: 'user',
                                content: isTest ? 'ä½ å¥½ï¼Œè¿™æ˜¯è¿æ¥æµ‹è¯•' : prompt
                            }],
                            stream: false
                        };
                        break;

                    case 'qianwen':
                        headers = {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json'
                        };
                        requestBody = {
                            model: 'qwen-plus',
                            input: {
                                messages: [{
                                    role: 'user',
                                    content: isTest ? 'ä½ å¥½ï¼Œè¿™æ˜¯è¿æ¥æµ‹è¯•' : prompt
                                }]
                            }
                        };
                        break;

                    case 'openai':
                        headers = {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json'
                        };
                        requestBody = {
                            model: 'gpt-3.5-turbo',
                            messages: [{
                                role: 'user',
                                content: isTest ? 'Hello, this is a connection test' : prompt
                            }]
                        };
                        break;
                }

                const response = await fetch(baseUrl, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                let content;
                switch (apiType) {
                    case 'zhipu':
                    case 'openai':
                        content = data.choices?.[0]?.message?.content;
                        break;
                    case 'qianwen':
                        content = data.output?.text;
                        break;
                }

                return { success: true, content: content };

            } catch (error) {
                console.error('APIè°ƒç”¨é”™è¯¯:', error);
                return { success: false, error: error.message };
            }
        }

        async function generateMockInsight() {
            const chapter = bookChapters[currentChapter];
            
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            const mockInsight = {
                content: `ğŸ¯ æ ¸å¿ƒè§‚ç‚¹ï¼š

1. **${chapter.title}å¼ºè°ƒå†…åœ¨è½¬åŒ–çš„åŠ›é‡** - çœŸæ­£çš„æ”¹å˜æ¥è‡ªäºå†…å¿ƒæ·±å¤„çš„è§‰é†’ï¼Œè€Œä¸æ˜¯å¤–åœ¨ç¯å¢ƒçš„æ”¹å˜
2. **å®½æ•æ˜¯è‡ªæˆ‘è§£æ”¾çš„å…³é”®** - å®½æ•ä»–äººå®é™…ä¸Šæ˜¯åœ¨è§£æ”¾è‡ªå·±ï¼Œè®©å¿ƒçµè·å¾—çœŸæ­£çš„è‡ªç”±ä¸å¹³å®‰
3. **çˆ±æ˜¯ä¸€åˆ‡é—®é¢˜çš„ç»ˆæç­”æ¡ˆ** - ç”¨çˆ±çš„çœ¼å…‰çœ‹å¾…äººç”Ÿï¼Œæ‰€æœ‰çš„å›°éš¾å’ŒæŒ‘æˆ˜éƒ½ä¼šè½¬åŒ–ä¸ºæˆé•¿çš„æœºä¼š

ğŸ’¡ ä¸ªäººæˆé•¿å¯å‘ï¼š

æ¯ä¸ªäººå†…å¿ƒéƒ½æœ‰é€‰æ‹©çˆ±æˆ–ææƒ§çš„è‡ªç”±ã€‚å½“æˆ‘ä»¬å‹‡æ•¢åœ°é€‰æ‹©çˆ±æ—¶ï¼Œå¥‡è¿¹å°±ä¼šåœ¨ç”Ÿå‘½ä¸­è‡ªç„¶å‘ç”Ÿã€‚å®½æ•ä¸æ˜¯å¯¹é”™è¯¯çš„çºµå®¹ï¼Œè€Œæ˜¯å¯¹è‡ªå·±å¿ƒçµçš„æ…ˆæ‚²ï¼Œæ˜¯å†…åœ¨åŠ›é‡å’Œæ™ºæ…§çš„ä½“ç°ã€‚

ğŸŒŸ ç”Ÿæ´»å®é™…åº”ç”¨ï¼š

â€¢ **å†²çªå¤„ç†æ³•**ï¼šé‡åˆ°äººé™…å†²çªæ—¶ï¼Œå…ˆé—®è‡ªå·±"æˆ‘çœŸæ­£æ¸´æœ›çš„æ˜¯ä»€ä¹ˆï¼Ÿ"é€šå¸¸ç­”æ¡ˆéƒ½æ˜¯ç†è§£å’Œå…³çˆ±
â€¢ **æ¯æ—¥å®½æ•ç»ƒä¹ **ï¼šç¡å‰å›é¡¾ä¸€å¤©ï¼Œå¯¹ä»»ä½•æ€¨æ¨æˆ–ä¸æ»¡çš„æƒ…ç»ªè¯´"æˆ‘é€‰æ‹©å®½æ•ï¼Œæˆ‘é€‰æ‹©é‡Šæ”¾"
â€¢ **çˆ±å¿ƒå†¥æƒ³**ï¼šæ¯å¤©èŠ±5åˆ†é’Ÿå‘è‡ªå·±å’Œä»–äººé€å‡ºçˆ±çš„ç¥ç¦ï¼ŒåŸ¹å…»æ…ˆæ‚²å¿ƒ

ğŸ“± çŸ­è§†é¢‘æ–‡æ¡ˆï¼š

**é‡‘å¥ç‰ˆ**ï¼š
"${chapter.title}" - çœŸæ­£çš„åŠ›é‡ä¸åœ¨äºæ”¹å˜ä¸–ç•Œï¼Œè€Œåœ¨äºæ”¹å˜è‡ªå·±çš„å¿ƒ ğŸ’« #å¿ƒçµæˆé•¿ #å®½æ•çš„åŠ›é‡ #å†…åœ¨è§‰é†’

**æ•…äº‹ç‰ˆ**ï¼š
ä»Šå¤©å­¦åˆ°æœ€æ·±åˆ»çš„é“ç†ï¼šæœ‰äººé—®ä»€ä¹ˆæ˜¯å®½æ•ï¼Ÿæ™ºè€…å›ç­”ï¼šå®½æ•å°±æ˜¯ç»™è‡ªå·±çš„å¿ƒçµæ¾ç»‘ï¼Œè®©çˆ±é‡æ–°æµåŠ¨ â¤ï¸ #å®½æ•å°±æ˜¯çˆ± #å¿ƒçµè‡ªç”±

**äº’åŠ¨ç‰ˆ**ï¼š
ä½ è§‰å¾—æœ€éš¾å®½æ•çš„æ˜¯ä»€ä¹ˆï¼Ÿæ˜¯åˆ«äººçš„ä¼¤å®³è¿˜æ˜¯è‡ªå·±çš„è¿‡é”™ï¼Ÿè¯„è®ºåŒºåˆ†äº«ä½ çš„å®½æ•æ•…äº‹ ğŸ¤— #å®½æ• #å†…åœ¨æˆé•¿ #å¿ƒçµç–—æ„ˆ

ğŸ·ï¸ æ¨èæ ‡ç­¾ï¼š
#å®½æ•å°±æ˜¯çˆ± #å¿ƒçµæˆé•¿ #å†…åœ¨åŠ›é‡ #ä¸ªäººæˆé•¿ #æ­£å¿µç”Ÿæ´» #å¿ƒçµç–—æ„ˆ #è‡ªæˆ‘è§‰é†’`,
                timestamp: new Date().toISOString()
            };

            displayAIResult(mockInsight, chapter.title);
            
            readingProgress[currentChapter] = {
                date: new Date().toISOString(),
                insight: mockInsight
            };
            
            localStorage.setItem('readingProgress', JSON.stringify(readingProgress));
            updateStats();
            renderChapters();
        }

        function displayAIResult(insight, chapterTitle) {
            const resultDiv = document.getElementById('aiResult');
            
            resultDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="color: #d63031; margin: 0;">ğŸ¤– AIæ·±åº¦åˆ†æï¼š${chapterTitle}</h3>
                    <small style="color: #666;">
                        ${new Date(insight.timestamp).toLocaleString()}
                    </small>
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 10px; white-space: pre-wrap; line-height: 1.8; box-shadow: 0 3px 10px rgba(0,0,0,0.1);">
                    ${insight.content}
                </div>
                
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd; text-align: center;">
                    <small style="color: #666;">
                        ç”± ${apiConfig.apiType?.toUpperCase() || 'AI'} ç”Ÿæˆ â€¢ 
                        <button onclick="shareInsight()" style="background: none; border: none; color: #4facfe; cursor: pointer; text-decoration: underline;">åˆ†äº«æ­¤åˆ†æ</button>
                    </small>
                </div>
            `;
            
            resultDiv.classList.remove('hidden');
        }

        // è¾…åŠ©åŠŸèƒ½
        function toggleNote() {
            const noteArea = document.getElementById('personalNote');
            
            if (noteArea.style.display === 'none' || !noteArea.style.display) {
                noteArea.style.display = 'block';
                noteArea.value = personalNotes[currentChapter] || '';
                noteArea.focus();
            } else {
                personalNotes[currentChapter] = noteArea.value;
                localStorage.setItem('personalNotes', JSON.stringify(personalNotes));
                noteArea.style.display = 'none';
                
                showStatus('ğŸ“ ç¬”è®°å·²ä¿å­˜', 'success');
                renderChapters(); // æ›´æ–°ç« èŠ‚æ˜¾ç¤º
                loadChapter(currentChapter); // åˆ·æ–°å½“å‰ç« èŠ‚æ˜¾ç¤º
            }
        }

        function shareInsight() {
            const chapter = bookChapters[currentChapter];
            const progress = readingProgress[currentChapter];
            
            let shareText = `ğŸ“– æ­£åœ¨é˜…è¯»ã€Šå®½æ•å°±æ˜¯çˆ±ã€‹- "${chapter.title}"\n\n`;
            
            if (progress && progress.insight) {
                const content = progress.insight.content;
                const preview = content.length > 200 ? content.substring(0, 200) + '...' : content;
                shareText += `ğŸ’¡ AIæ·±åº¦åˆ†æèŠ‚é€‰ï¼š\n${preview}\n\n`;
            }
            
            shareText += `#å®½æ•å°±æ˜¯çˆ± #AIé˜…è¯»åŠ©æ‰‹ #å¿ƒçµæˆé•¿ #æ¯æ—¥æ„Ÿæ‚Ÿ`;

            if (navigator.share) {
                navigator.share({
                    title: 'å®½æ•å°±æ˜¯çˆ± - AIé˜…è¯»æ„Ÿæ‚Ÿ',
                    text: shareText
                }).catch(console.error);
            } else {
                navigator.clipboard.writeText(shareText).then(() => {
                    showStatus('ğŸ“‹ æ„Ÿæ‚Ÿå·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼', 'success');
                }).catch(() => {
                    showStatus('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
                });
            }
        }

        function markAllRead() {
            if (confirm('ç¡®å®šè¦å°†æ‰€æœ‰ç« èŠ‚æ ‡è®°ä¸ºå·²è¯»å—ï¼Ÿè¿™å°†ä¸ºæ‰€æœ‰ç« èŠ‚ç”Ÿæˆé˜…è¯»è®°å½•ã€‚')) {
                bookChapters.forEach((_, index) => {
                    if (!readingProgress[index]) {
                        readingProgress[index] = {
                            date: new Date().toISOString(),
                            insight: { content: 'å·²æ ‡è®°ä¸ºå·²è¯»', timestamp: new Date().toISOString() }
                        };
                    }
                });
                
                localStorage.setItem('readingProgress', JSON.stringify(readingProgress));
                updateStats();
                renderChapters();
                showStatus('âœ“ æ‰€æœ‰ç« èŠ‚å·²æ ‡è®°ä¸ºå·²è¯»ï¼', 'success');
            }
        }

        function resetProgress() {
            if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰é˜…è¯»è¿›åº¦å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                readingProgress = {};
                personalNotes = {};
                localStorage.removeItem('readingProgress');
                localStorage.removeItem('personalNotes');
                
                updateStats();
                renderChapters();
                document.getElementById('aiResult').classList.add('hidden');
                
                showStatus('ğŸ”„ é˜…è¯»è¿›åº¦å·²é‡ç½®', 'success');
            }
        }

        function autoReadMode() {
            const autoBtn = document.getElementById('autoBtn');
            
            if (autoReadTimer) {
                clearInterval(autoReadTimer);
                autoReadTimer = null;
                autoBtn.textContent = 'è‡ªåŠ¨é˜…è¯»æ¨¡å¼';
                autoBtn.style.background = '';
                showStatus('â¸ è‡ªåŠ¨é˜…è¯»æ¨¡å¼å·²å…³é—­', 'success');
                return;
            }

            if (confirm('å¼€å¯è‡ªåŠ¨é˜…è¯»æ¨¡å¼ï¼Ÿç³»ç»Ÿå°†æ¯30ç§’è‡ªåŠ¨åˆ‡æ¢åˆ°ä¸‹ä¸€ç« ã€‚')) {
                autoBtn.textContent = 'åœæ­¢è‡ªåŠ¨é˜…è¯»';
                autoBtn.style.background = 'linear-gradient(135deg, #ff6b6b 0%, #ffa500 100%)';
                
                autoReadTimer = setInterval(() => {
                    const nextIndex = (currentChapter + 1) % bookChapters.length;
                    loadChapter(nextIndex);
                }, 30000);
                
                showStatus('â–¶ è‡ªåŠ¨é˜…è¯»æ¨¡å¼å·²å¼€å¯ - æ¯30ç§’åˆ‡æ¢ç« èŠ‚', 'success');
            }
        }

        function exportProgress() {
            const exportData = {
                bookTitle: 'å®½æ•å°±æ˜¯çˆ±',
                exportDate: new Date().toISOString(),
                totalChapters: bookChapters.length,
                completedChapters: Object.keys(readingProgress).length,
                progressPercentage: Math.round((Object.keys(readingProgress).length / bookChapters.length) * 100),
                readingProgress: readingProgress,
                personalNotes: personalNotes,
                chapters: bookChapters.map(ch => ch.title)
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `å®½æ•å°±æ˜¯çˆ±-é˜…è¯»è¿›åº¦-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showStatus('ğŸ“¤ é˜…è¯»è¿›åº¦å·²å¯¼å‡ºï¼', 'success');
        }

        function exportInsights() {
            let markdownContent = `# ã€Šå®½æ•å°±æ˜¯çˆ±ã€‹- AIé˜…è¯»æ„Ÿæ‚Ÿåˆé›†\n\n`;
            markdownContent += `**ç”Ÿæˆæ—¶é—´ï¼š** ${new Date().toLocaleString()}\n`;
            markdownContent += `**é˜…è¯»è¿›åº¦ï¼š** ${Object.keys(readingProgress).length}/${bookChapters.length} ç« \n\n`;
            markdownContent += `---\n\n`;

            bookChapters.forEach((chapter, index) => {
                markdownContent += `## ç¬¬${index + 1}ç« ï¼š${chapter.title}\n\n`;
                
                if (readingProgress[index]) {
                    const progress = readingProgress[index];
                    markdownContent += `**å®Œæˆæ—¶é—´ï¼š** ${new Date(progress.date).toLocaleString()}\n\n`;
                    
                    if (progress.insight && progress.insight.content) {
                        markdownContent += `### ğŸ¤– AIæ·±åº¦åˆ†æ\n\n`;
                        markdownContent += `${progress.insight.content}\n\n`;
                    }
                }
                
                if (personalNotes[index]) {
                    markdownContent += `### ğŸ“ ä¸ªäººç¬”è®°\n\n`;
                    markdownContent += `${personalNotes[index]}\n\n`;
                }
                
                if (!readingProgress[index]) {
                    markdownContent += `*ğŸ“– å¾…é˜…è¯»*\n\n`;
                }
                
                markdownContent += `---\n\n`;
            });

            markdownContent += `\n*æœ¬æ–‡æ¡£ç”±ã€Šå®½æ•å°±æ˜¯çˆ±ã€‹AIæ™ºèƒ½é˜…è¯»åŠ©æ‰‹ç”Ÿæˆ*\n`;

            const blob = new Blob([markdownContent], {type: 'text/markdown; charset=utf-8'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `å®½æ•å°±æ˜¯çˆ±-AIæ„Ÿæ‚Ÿåˆé›†-${new Date().toISOString().split('T')[0]}.md`;
            link.click();
            
            showStatus('ğŸ“ æ‰€æœ‰æ„Ÿæ‚Ÿå·²å¯¼å‡ºä¸ºMarkdownæ–‡ä»¶ï¼', 'success');
        }

        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', function(event) {
            if (bookChapters.length === 0) return;

            switch(event.key) {
                case 'ArrowLeft':
                    if (currentChapter > 0 && !event.ctrlKey) {
                        loadChapter(currentChapter - 1);
                    }
                    break;
                case 'ArrowRight':
                    if (currentChapter < bookChapters.length - 1 && !event.ctrlKey) {
                        loadChapter(currentChapter + 1);
                    }
                    break;
                case 'g':
                    if (event.ctrlKey) {
                        event.preventDefault();
                        generateInsight();
                    }
                    break;
                case 's':
                    if (event.ctrlKey) {
                        event.preventDefault();
                        toggleNote();
                    }
                    break;
            }
        });

        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', function() {
            if (autoReadTimer) {
                clearInterval(autoReadTimer);
            }
        });

        console.log('ğŸš€ å®½æ•å°±æ˜¯çˆ± - AIæ™ºèƒ½é˜…è¯»åŠ©æ‰‹å·²åŠ è½½å®Œæˆï¼');
    </script>
</body>
</html>